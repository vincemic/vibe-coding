<div class="quiz-container" *ngIf="state$ | async as state">
  <!-- Header -->
  <app-quiz-header
    [connectionStatus]="state.connectionStatus"
    [isConnected]="isConnected()"
    [playersCount]="state.players.length"
    (toggleLeaderboard)="toggleLeaderboard()">
  </app-quiz-header>

  <!-- Progress bar for active game -->
  <app-quiz-progress [currentQuestion]="state.currentQuestion"></app-quiz-progress>

  <!-- Main Content -->
  <div class="quiz-content">
    
    <!-- Joining State -->
    <app-join-game
      *ngIf="state.currentState === QuizState.Joining"
      [playerName]="state.playerName"
      [isJoining]="state.isJoining"
      (joinGame)="joinGame($event)">
    </app-join-game>

    <!-- Waiting for Players -->
    <div *ngIf="state.currentState === QuizState.WaitingForPlayers" class="waiting-section">
      <div class="waiting-card">
        <h2>🎉 Welcome {{ state.currentPlayer?.name }}!</h2>
        <p>Waiting for more players to join...</p>
        <div class="player-count">
          <strong>{{ state.players.length }}/10 Players</strong>
        </div>
        <div *ngIf="state.players.length >= 2" class="start-hint">
          <p>✨ Game will start automatically with {{ state.players.length }} players!</p>
        </div>
      </div>
    </div>

    <!-- Game Starting -->
    <div *ngIf="state.currentState === QuizState.Starting" class="starting-section">
      <div class="starting-card">
        <h2>🚀 Game Starting!</h2>
        <p>Get ready for {{ state.currentQuestion?.totalQuestions || 10 }} exciting questions!</p>
        <div class="countdown">3</div>
      </div>
    </div>

    <!-- Question Display and Answer Sections -->
    <app-question-display
      *ngIf="state.currentState === QuizState.QuestionDisplay || state.currentState === QuizState.WaitingForAnswers"
      [currentState]="state.currentState"
      [currentQuestion]="state.currentQuestion"
      [selectedAnswer]="state.selectedAnswer"
      [hasAnswered]="state.hasAnswered"
      [timeRemaining]="state.timeRemaining"
      [answeredCount]="state.answeredCount"
      [totalPlayers]="state.totalPlayers"
      (submitAnswer)="submitAnswer($event)">
    </app-question-display>

    <!-- Question Results -->
    <div *ngIf="state.currentState === QuizState.ShowingResults" class="results-section">
      <div class="results-card" *ngIf="state.questionResult">
        <h2>📊 Question {{ (state.currentQuestion?.questionNumber || 1) }} Results</h2>
        
        <div class="correct-answer">
          <h3>✅ Correct Answer: {{ getOptionLetter(state.questionResult.correctAnswer) }}</h3>
          <p class="answer-text">{{ state.questionResult.question.options[state.questionResult.correctAnswer] }}</p>
          <p class="explanation">{{ state.questionResult.explanation }}</p>
        </div>
        
        <div class="player-results">
          <h4>Player Performance:</h4>
          <div class="result-list">
            <div 
              *ngFor="let result of state.questionResult.playerResults" 
              class="player-result"
              [class.correct]="result.isCorrect"
              [class.current-player]="result.playerId === state.currentPlayer?.id">
              <span class="player-name">{{ result.playerName }}</span>
              <span class="player-answer">
                {{ result.selectedOption >= 0 ? getOptionLetter(result.selectedOption) : '❌' }}
              </span>
              <span class="score-gained" *ngIf="result.scoreGained > 0">
                +{{ result.scoreGained }}
              </span>
              <span class="total-score">{{ result.totalScore }} pts</span>
            </div>
          </div>
        </div>

        <div class="next-question">
          <p>🔄 Next question coming up...</p>
        </div>
      </div>
    </div>

    <!-- Game Over -->
    <div *ngIf="state.currentState === QuizState.GameOver" class="gameover-section">
      <div class="gameover-card" *ngIf="state.finalResults">
        <h2>🏁 Game Complete!</h2>
        
        <div *ngIf="state.finalResults.winner" class="winner-announcement">
          <h3>🏆 Champion: {{ state.finalResults.winner.playerName }}!</h3>
          <p class="winner-score">Final Score: {{ state.finalResults.winner.totalScore }} points</p>
          <div *ngIf="state.finalResults.winner.playerId === state.currentPlayer?.id" class="victory-message">
            🎉 Congratulations! You are the Quiz Master! 🎉
          </div>
        </div>
        
        <div class="final-leaderboard">
          <h4>📊 Final Leaderboard:</h4>
          <div class="leaderboard-list">
            <div 
              *ngFor="let player of state.finalResults.finalScores; let i = index" 
              class="leaderboard-item"
              [class.winner]="i === 0"
              [class.current-player]="player.playerId === state.currentPlayer?.id">
              <span class="rank">{{ i + 1 }}</span>
              <span class="name">{{ player.playerName }}</span>
              <span class="score" [style.color]="getScoreColor(player.totalScore)">
                {{ player.totalScore }} pts
              </span>
            </div>
          </div>
        </div>

        <div class="game-stats">
          <h4>📈 Game Statistics:</h4>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">Duration:</span>
              <span class="stat-value">{{ state.finalResults.statistics.gameDuration }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Players:</span>
              <span class="stat-value">{{ state.finalResults.statistics.totalPlayers }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Questions:</span>
              <span class="stat-value">{{ state.finalResults.statistics.totalQuestions }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Avg Score:</span>
              <span class="stat-value">{{ state.finalResults.statistics.averageScore | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>

        <div class="game-actions">
          <button class="play-again-button" (click)="playAgain()">
            🔄 Play Again
          </button>
        </div>
      </div>
    </div>

    <!-- Side Panel: Leaderboard -->
    <div *ngIf="state.showLeaderboard && state.players.length > 0" class="leaderboard-panel">
      <div class="panel-header">
        <h3>🏆 Current Scores</h3>
        <button class="close-button" (click)="toggleLeaderboard()">×</button>
      </div>
      <div class="current-leaderboard">
        <div 
          *ngFor="let player of state.players; let i = index" 
          class="leaderboard-entry"
          [class.current-player]="player.id === state.currentPlayer?.id">
          <span class="rank">{{ i + 1 }}</span>
          <span class="name">{{ player.name }}</span>
          <span class="score">{{ player.score }}</span>
          <span *ngIf="player.hasAnswered" class="answered-indicator">✅</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Quiz Master Messages -->
  <app-quiz-master-panel [messages]="state.quizMasterMessages"></app-quiz-master-panel>

</div>
